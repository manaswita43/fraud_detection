name: CD - Full MLOps Validation & Deployment

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-evaluate-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write

    env:
      PROJECT_ID: ${{ secrets.PROJECT_ID }}
      REGION: us-central1
      REPO_NAME: aml-repo
      IMAGE_NAME: fraud-detector
      CLUSTER_NAME: fraud-cluster
      DEPLOYMENT_NAME: fraud-detector
      NAMESPACE: default

    steps:
    # -----------------------------------
    # Checkout
    # -----------------------------------
    - uses: actions/checkout@v4

    # -----------------------------------
    # Auth
    # -----------------------------------
    - uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - uses: google-github-actions/setup-gcloud@v1

    # -----------------------------------
    # Install tools
    # -----------------------------------
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq
        npm install -g @dvcorg/cml
        pip install -r app/requirements.txt

    # -----------------------------------
    # Build & Push
    # -----------------------------------
    - name: Configure Docker
      run: gcloud auth configure-docker us-central1-docker.pkg.dev -q

    - name: Build & Push Image
      run: |
        IMAGE_URI=us-central1-docker.pkg.dev/$PROJECT_ID/$REPO_NAME/$IMAGE_NAME:${{ github.sha }}
        docker build -t $IMAGE_URI ./app
        docker push $IMAGE_URI
        echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV

    # -----------------------------------
    # Model Evaluation
    # -----------------------------------
    - name: Run model evaluation
      run: |
        python scripts/eval_model.py \
          --model app/model.pkl \
          --data data/v1/transactions_2023.csv

    # -----------------------------------
    # Explainability (SHAP)
    # -----------------------------------
    - name: Run explainability
      run: |
        python scripts/explainability.py

    # -----------------------------------
    # Fairness & Drift
    # -----------------------------------
    - name: Run drift & fairness checks
      run: |
        python scripts/drift_check.py

    # -----------------------------------
    # GKE Deployment Verification
    # -----------------------------------
    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials $CLUSTER_NAME \
          --region $REGION \
          --project $PROJECT_ID

    - name: Verify rollout
      run: |
        kubectl rollout status deployment/$DEPLOYMENT_NAME \
          -n $NAMESPACE --timeout=120s

    - name: Fetch pod logs
      run: |
        POD=$(kubectl get pods -n $NAMESPACE \
          -l app=$DEPLOYMENT_NAME \
          -o jsonpath="{.items[0].metadata.name}")
        kubectl logs $POD -n $NAMESPACE --tail=50 > pod_logs.txt

    # -----------------------------------
    # CML REPORT
    # -----------------------------------
    - name: Publish CML report
      if: always()
      env:
        REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        ACC=$(jq '.accuracy' metrics.json)
        PREC=$(jq '.precision' metrics.json)
        REC=$(jq '.recall' metrics.json)
        F1=$(jq '.f1' metrics.json)

        echo "## MLOps CD Report" > report.md
        echo "" >> report.md
        echo "### ðŸ”§ Build & Deployment" >> report.md
        echo "- Docker Image: \`$IMAGE_URI\`" >> report.md
        echo "- GKE Deployment: âœ… Verified" >> report.md
        echo "" >> report.md

        echo "### Model Performance" >> report.md
        echo "| Metric | Value |" >> report.md
        echo "|-------|-------|" >> report.md
        echo "| Accuracy | $ACC |" >> report.md
        echo "| Precision | $PREC |" >> report.md
        echo "| Recall | $REC |" >> report.md
        echo "| F1 Score | $F1 |" >> report.md
        echo "" >> report.md

        echo "### Explainability" >> report.md
        echo "- SHAP summary plot generated" >> report.md
        echo "" >> report.md

        echo "### Fairness & Drift" >> report.md
        echo "- Evidently drift report generated" >> report.md
        echo "- Drift comparison plot created" >> report.md
        echo "" >> report.md

        echo "### Commit" >> report.md
        echo "\`${{ github.sha }}\`" >> report.md

        cml comment create report.md
        cml artifact upload artifacts/shap_summary.png
        cml artifact upload artifacts/drift_comparison.png
        cml artifact upload artifacts/evidently_drift_report.html
        cml artifact upload pod_logs.txt
